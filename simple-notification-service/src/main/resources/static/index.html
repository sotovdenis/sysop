<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>WebSocket demo</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        #messages { border: 1px solid #ccc; padding: 10px; height: 300px; overflow-y: scroll; }
        .log { color: gray; font-size: 0.8em; }
        .msg { color: blue; font-weight: bold; }
        .ping { color: green; font-weight: bold; }
        .pong { color: orange; font-weight: bold; }
    </style>
</head>
<body>
<h2>Live Notifications</h2>
<div id="status">Status: Disconnected</div>
<button onclick="sendTestMessage()">Send Test Message</button>
<button onclick="togglePing()" id="pingToggle">Start Ping</button>
<div id="messages"></div>

<script>
    const statusDiv = document.getElementById('status');
    const messagesDiv = document.getElementById('messages');
    const pingToggleBtn = document.getElementById('pingToggle');

    let socket1 = null;
    let reconnectAttempts = 0;
    let reconnectTimer = null;
    let pingInterval = null;
    let isPingActive = false;
    const MAX_RECONNECT_DELAY = 30000; // макс. 30 сек между попытками
    const PING_INTERVAL = 10000;

    function connect() {
        if (socket1 && socket1.readyState === WebSocket.CONNECTING) {
            return;
        }

        if (reconnectTimer) {
            clearTimeout(reconnectTimer);
            reconnectTimer = null;
        }

        const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';

        let userId = new Date().getTime() % 1000;

        socket1 = new WebSocket(`${protocol}//localhost:8080/ws/notifications?userId=${userId}`);


        socket1.onopen = function() {
            reconnectAttempts = 0;
            statusDiv.textContent = `Status: Connected ${userId}`;
            statusDiv.style.color = 'green';
            log('Соединение установлено');

            startPing();
        };


        socket1.onmessage = function(event) {
            const message = event.data;

            if (message === 'PONG') {
                log('Получен PONG', 'pong');
            } else {
                log('Получено: ' + message, 'msg');
            }
        };


        socket1.onclose = function(event) {
            statusDiv.textContent = 'Status: Disconnected';
            statusDiv.style.color = 'red';

            stopPing();

            const reason = event.wasClean
                ? `закрыто чисто, код=${event.code}`
                : 'обрыв соединения';
            log(`Отключение: ${reason}`);

            scheduleReconnect();
        };

        socket1.onerror = function() {
            // WebSocket error event не содержит деталей (по соображениям безопасности)
            log('Ошибка соединения');
        };


    }

    function scheduleReconnect() {
        // Exponential backoff: 1s, 2s, 4s, 8s... до MAX_RECONNECT_DELAY
        const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), MAX_RECONNECT_DELAY);
        reconnectAttempts++;

        log(`Переподключение через ${delay/1000} сек (попытка ${reconnectAttempts})...`);
        reconnectTimer = setTimeout(connect, delay);
    }

    function startPing() {
        if (pingInterval) {
            clearInterval(pingInterval);
        }

        isPingActive = true;
        pingToggleBtn.textContent = 'Stop Ping';

        sendPing();

        pingInterval = setInterval(() => {
            sendPing();
        }, PING_INTERVAL);

        log('Ping запущен (каждые 10 сек)', 'ping');
    }

    function stopPing() {
        if (pingInterval) {
            clearInterval(pingInterval);
            pingInterval = null;
        }
        isPingActive = false;
        pingToggleBtn.textContent = 'Start Ping';
        log('Ping остановлен', 'ping');
    }

    function togglePing() {
        if (isPingActive) {
            stopPing();
        } else {
            if (socket1 && socket1.readyState === WebSocket.OPEN) {
                startPing();
            } else {
                log('Нет подключения для отправки ping', 'log');
            }

        }
    }

    function sendPing() {
        if (socket1 && socket1.readyState === WebSocket.OPEN) {
            socket1.send('PING');
            log('Отправлен PING jn s1', 'ping');
        } else {
            log('Не удалось отправить PING - соединение закрыто', 'log');
            stopPing();
        }

    }

    function sendTestMessage() {
        if (socket1 && socket1.readyState === WebSocket.OPEN) {
            const testMessage = 'Тестовое сообщение ' + new Date().toLocaleTimeString();
            socket1.send(testMessage);
            log('Отправлено: ' + testMessage, 'msg');
        } else {
            log('Нет подключения для отправки сообщения', 'log');
        }

    }

    function log(text, type = 'log') {
        const div = document.createElement('div');
        div.className = type;
        div.textContent = `[${new Date().toLocaleTimeString()}] ${text}`;
        messagesDiv.appendChild(div);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    window.addEventListener('beforeunload', function() {
        stopPing();
        if (socket1) {
            socket1.close();
        }

    });

    connect();
</script>
</body>
</html>